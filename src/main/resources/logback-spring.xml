<configuration>

    <!-- Include environment variables -->
    <property name="NEW_RELIC_LICENSE_KEY" value="eu01xx577cc0f7d76378de40516191a3FFFFNRAL"/>
    <property name="APP_NAME" value="hello-world-webapp"/>

    <!-- Console appender for local debugging -->
    <appender name="Console" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <customFields>{"app":"${APP_NAME}"}</customFields>
            <includeMdcKeyName>requestId,userId,sessionId</includeMdcKeyName>

            <!-- Masking emails using MaskingJsonGeneratorDecorator -->
            <jsonGeneratorDecorator class="net.logstash.logback.mask.MaskingJsonGeneratorDecorator">
                <defaultMask>********</defaultMask>
                <value>[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-z]{2,}</value>
            </jsonGeneratorDecorator>
        </encoder>
    </appender>

    <!-- New Relic Appender -->
    <appender name="NewRelic" class="com.newrelic.logging.logback.NewRelicEncoder">
        <apiKey>${NEW_RELIC_LICENSE_KEY}</apiKey>
        <serviceName>${APP_NAME}</serviceName>
        <logLevel>INFO</logLevel>
        <logFormat>JSON</logFormat>
        <includeMdcKeyName>requestId,userId,sessionId</includeMdcKeyName>

        <!-- Masking emails in New Relic logs as well -->
        <jsonGeneratorDecorator class="net.logstash.logback.mask.MaskingJsonGeneratorDecorator">
            <defaultMask>********</defaultMask>
            <value>[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-z]{2,}</value>
        </jsonGeneratorDecorator>
    </appender>

    <!-- Root logger -->
    <root level="INFO">
        <appender-ref ref="Console"/>
        <appender-ref ref="NewRelic"/>
    </root>

</configuration>
